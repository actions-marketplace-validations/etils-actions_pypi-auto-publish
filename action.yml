name: 'Build & auto-publish to PyPI'
author: 'Conchylicultor'
description: 'Build & publish to PyPI when `my_module.__version__` is increased'
branding:
  icon: upload-cloud
  color: orange

inputs:
  module-name:
    description: 'The name of the module to import.'
    required: true
  pkg-name:
    description: 'Name of the PyPI package.'
    required: false
  pypi-token:
    description: 'Token of the PyPI account publishing the project.'
    required: true

runs:
  using: "composite"
  steps:
    - run: pip install packaging
      shell: bash

    # Get the local and PyPI versions
    # Check if local `__version__` < pip version
    # Output: `compare-version.outputs.should-release`
    - id: compare-version
      run: |
        python ${{github.action_path}}/src/compare_version.py \
          --module_name="${{ inputs.module-name }}" \
          --pkg_name="${{ inputs.pkg-name }}" \
      shell: bash

    - run: echo ${{ steps.compare-version.outputs.should-release }}
      shell: bash

    - run: echo ${{ steps.compare-version.outputs.version }}
      shell: bash

    # Publish the package (if local `__version__` < pip version)
    - if: steps.compare-version.outputs.should-release == 'true'
      uses: etils-actions/pypi-build-publish@v1
      with:
        pypi-token: ${{ inputs.pypi-token }}
